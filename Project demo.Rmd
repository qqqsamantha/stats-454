---
title: "Project demo"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(ggplot2)
library(tidyverse)
library(tidybayes)
library(tidymodels)
library(rstan)
library(rstanarm)
library(bayesplot)
library(bayesrules)
library(broom.mixed)
library(pracma)
library(probably)
hotel <- read.csv("https://raw.githubusercontent.com/yiyangshi-hub/STAT454-Project/main/hotel_bookings.csv")
```

### Data Clean up
```{r}
hotel_clean <- hotel %>% 
  select(-reservation_status, -reservation_status_date,-company, -arrival_date_day_of_month, -days_in_waiting_list, -agent) %>% 
  filter(country %in%
           c("AUT","BEL","BRA","CHE","CHN","CN","DEU","ESP","FRA","GBR","IRL",
             "ISR","ITA","NLD","NOR","POL","PRT","RUS","SWE","USA")) %>% 
  mutate(is_canceled = factor(is_canceled),
         hotel = factor(hotel),
         arrival_date_year = factor(arrival_date_year),
         arrival_date_month = factor(arrival_date_month),
         arrival_date_week_number = factor(arrival_date_week_number),
         meal = factor(meal),
         market_segment = factor(market_segment),
         distribution_channel = factor(distribution_channel),
         is_repeated_guest = factor(is_repeated_guest),
         reserved_room_type = factor(reserved_room_type),
         assigned_room_type = factor(assigned_room_type),
         deposit_type = factor(deposit_type),
         customer_type = factor(customer_type),
         previous_cancellations = factor(previous_cancellations),
         country = factor(country),
         ) %>% 
  na.omit()


# random sample 1000 rows from the big dataframe 'hotel'
set.seed(123)
hotel_sub <- sample_n(hotel_clean, 1000)
```

```{r}
hotel_sub%>%
  head()
```

### Data Visualization
> In deciding whether the hotel is going to be canceled, we are curious in if the type of the hotel will affect the result. 

> First, we construct a plot for the type of hotel vs is_canceled.

```{r}
hotel_clean %>% 
  ggplot(aes(x = hotel)) +
  geom_bar()

hotel_clean %>% 
  ggplot(aes(x = hotel, fill = is_canceled)) +
  geom_bar(position = "fill")
```

> Then we see that in general, there are more city hotel than resort hotel in our dataset. However, when looking at the hotels that have been canceled, it is more likely for the City Hotel to be canceled than Resort Hotel. 

> Then we may wondering if this can be explained by the customers' own behavior, eg. some customers are more likely to cancel the hotel than others. Then we look at previous cancellations which may reflect the customers behaviors.

```{r}
hotel_sub %>% 
  ggplot(aes(x = previous_cancellations, fill = is_canceled)) +
  geom_bar(position = "fill")
```

> From the graph above, we can see that those who did not cancel last time are also less likely to cancel this time than those who did cancel. 

> We may wondering if we could combine these information together.

```{r}
hotel_sub %>% 
  ggplot(aes(x = hotel, fill = previous_cancellations)) +
  geom_bar(position = "fill")
```

> It is clear that for those who previously canceled, there are more City Hotel than Resort Hotel.

> Thus, we would love to see how this affect the cancellation result.

```{r}
ggplot(hotel_sub, aes(x = hotel, 
                      y = is_canceled, 
                      color = previous_cancellations)) +
  geom_jitter(height = 0.25)
```

> We can see a clear cluster that those which is a City Hotel and who has previously canceled the hotel would devote the most cases to the hotel cancellations. Hotel type and previous_cancellations are 2 strong predictors.

> So we may wondering what other predictors, like Hotel type and previous_cancellations, can be used to model the hotel cancellations. Then we would dig deeper into model building.


### Frequentist Penalty Selection of LASSO Logistic Regression
```{r}
set.seed(123)

data_cv10 <- vfold_cv(hotel_sub, v = 10)


# Logistic LASSO Regression Model Spec
logistic_lasso_spec_tune <- logistic_reg() %>%
    set_engine('glmnet') %>%
    set_args(mixture = 1, penalty = tune()) %>%
    set_mode('classification')

# Recipe
logistic_rec <- recipe(is_canceled ~ ., data = hotel_sub) %>%
    step_normalize(all_numeric_predictors()) %>% 
    step_dummy(all_nominal_predictors()) %>%  
    step_nzv(all_predictors()) %>% 
    step_corr(all_predictors()) %>% 
    step_mutate(is_canceled = factor(is_canceled))
    # factor more categorical variables later on


# Workflow (Recipe + Model)
log_lasso_wf <- workflow() %>% 
    add_recipe(logistic_rec) %>%
    add_model(logistic_lasso_spec_tune) 


# Tune Model
penalty_grid <- grid_regular(
  penalty(range = c(-5,1)), #log10 transformed  (kept moving min down from 0)
  levels = 30)

tune_output <- tune_grid( 
  log_lasso_wf,
  resamples = data_cv10,
  metrics = metric_set(roc_auc,accuracy),
  control = control_resamples(save_pred = TRUE, event_level = 'second'),
  grid = penalty_grid 
)

# Visualize Model Evaluation Metrics from Tuning
autoplot(tune_output) + theme_classic()
```

```{r}
best_se_penalty <- 
  select_by_one_std_err(tune_output, 
                        metric = 'roc_auc', 
                        desc(penalty)) 
# choose penalty value based on the largest penalty within 1 se of the highest CV roc_auc
best_se_penalty
```
```{r}
final_fit_se <- finalize_workflow(log_lasso_wf, best_se_penalty) %>% # incorporates penalty value to workflow 
    fit(data = hotel_sub)

final_fit_se %>% tidy()
```


### Bayesian Logistic prior
```{r}
# set.seed(123)
# logistic_model_1 <- stan_glm(
#   is_canceled ~. , data = hotel_sub,
#   family = binomial,
#   chains = 4, iter = 5000*2, seed = 123, refresh = 0)
```


### Bayesian Lasso logistic prior and horseshoe prior
```{r}
set.seed(123)
#bayesian lasso logistic prior
bayes_lasso_log <- 
  stan_glm(is_canceled ~ .,
         family = binomial(), 
         prior = lasso(df = 10, location = 0, scale = 2.5,autoscale = TRUE),
         prior_intercept = normal(location = 0, scale = 10),
         prior_aux = exponential(rate = 1, autoscale = TRUE),
         data = hotel_sub)

tidy(bayes_lasso_log)

```

```{r}
# horseshoe prior
p0 <- 20
tau0 <- p0/(26-p0) * 1/sqrt(1000)
hs_prior <- hs(df=1, global_df=1, global_scale=tau0)
log_hs_model <- stan_glm(is_canceled~.,
                  data = hotel_sub,
                  family = binomial(link = "logit"), 
                  prior = hs_prior, 
                  chains = 4, iter = 500*2, 
                  seed = 123,
                  control = list(adapt_delta = 0.999,
                                 stepsize = 0.001,
                                 max_treedepth = 25),
                  refresh = 0)
```

```{r}
pp_check(log_hs_model)

mcmc_trace(log_hs_model,
           pars = vars(starts_with("country")))

mcmc_trace(log_hs_model,
           pars = vars(starts_with("arrival_date_year")))

mcmc_trace(log_hs_model,
           pars = vars(starts_with("arrival_date_month")))

mcmc_trace(log_hs_model,
           pars = vars(starts_with("arrival_date_week")))

mcmc_trace(log_hs_model,
           pars = vars(starts_with("is_repeated_guest"),
                           starts_with("previous_cancellations"),
                           starts_with("distribution_channel"),
                           starts_with("market_segment"),
                           starts_with("meal")))

mcmc_trace(log_hs_model,
           pars = vars(starts_with("reserved_room_type"),
                           starts_with("assigned_room_type"),
                           starts_with("deposit_type"),
                           starts_with("customer_type")))

mcmc_trace(log_hs_model,
           pars = vars(lead_time,
                           stays_in_weekend_nights,
                           stays_in_week_nights,
                           adults,
                           children,
                           babies,
                           previous_bookings_not_canceled,
                           booking_changes,
                           adr,
                           required_car_parking_spaces,
                           total_of_special_requests))
```


```{r}
mcmc_intervals(bayes_lasso_log,
               pars = vars(starts_with("country")))

mcmc_intervals(bayes_lasso_log,
               pars = vars(starts_with("arrival_date_year")))

mcmc_intervals(bayes_lasso_log,
               pars = vars(starts_with("arrival_date_month")))

mcmc_intervals(bayes_lasso_log,
               pars = vars(starts_with("arrival_date_week")))

mcmc_intervals(bayes_lasso_log,
               pars = vars(starts_with("is_repeated_guest"),
                           starts_with("previous_cancellations"),
                           starts_with("distribution_channel"),
                           starts_with("market_segment"),
                           starts_with("meal")))

mcmc_intervals(bayes_lasso_log,
               pars = vars(starts_with("reserved_room_type"),
                           starts_with("assigned_room_type"),
                           starts_with("deposit_type"),
                           starts_with("customer_type")))

mcmc_intervals(bayes_lasso_log,
               pars = vars(lead_time,
                           stays_in_weekend_nights,
                           stays_in_week_nights,
                           adults,
                           children,
                           babies,
                           previous_bookings_not_canceled,
                           booking_changes,
                           adr,
                           required_car_parking_spaces,
                           total_of_special_requests))
```

